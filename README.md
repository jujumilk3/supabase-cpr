# Supabase CPR (Database Keep-Alive Service)

An automated service to prevent Supabase databases from sleeping. It periodically accesses the database through GitHub Actions to keep it active.

## How It Works

1. Automatically runs every Monday at 00:00 UTC (or manually triggered)
2. Reads all `SUPABASE_DATABASE_*` environment variables from GitHub Secrets
3. For each database:
   - Creates `cpr_table` if it doesn't exist
   - Inserts a new record if the table exists

## Setup

### 1. Get Your Supabase Connection Pooler URL

**IMPORTANT:** You must use the **Connection Pooler** URL, not the direct connection URL, to avoid IPv6 issues in GitHub Actions.

From the Supabase Dashboard:
1. Select your project
2. Click the **"Connect"** button (top right)
3. Select **"Method -> Session Pooler"** mode (Port 5432)
4. Copy the connection string

The pooler URL format:
```
postgresql://postgres.[PROJECT_REF]:[PASSWORD]@aws-0-[REGION].pooler.supabase.com:5432/postgres
```

Example:
```
postgresql://postgres.abcdefghijklmnop:your_password@aws-0-us-west-1.pooler.supabase.com:5432/postgres
```

### 2. Add to GitHub Secrets

Navigate to Repository Settings > Secrets and variables > Actions and add your pooler connection strings:

```
SUPABASE_DATABASE_URL_PROD=postgresql://postgres.xxxxx:password@aws-0-us-west-1.pooler.supabase.com:5432/postgres
SUPABASE_DATABASE_URL_DEV=postgresql://postgres.yyyyy:password@aws-0-us-east-1.pooler.supabase.com:5432/postgres
```

Secret names must start with `SUPABASE_DATABASE_`, followed by any identifier you prefer.

All secrets starting with `SUPABASE_DATABASE_` are automatically detected - no need to modify the workflow file when adding new databases.

## Table Structure

The `cpr_table` that's automatically created:

```sql
CREATE TABLE public.cpr_table (
    id int8 GENERATED BY DEFAULT AS IDENTITY(
        INCREMENT BY 1
        MINVALUE 1
        MAXVALUE 9223372036854775807
        START 1
        CACHE 1
        NO CYCLE
    ) NOT NULL,
    created_at timestamptz DEFAULT now() NOT NULL,
    CONSTRAINT cpr_table_pkey PRIMARY KEY (id)
);
```

## Local Testing

```bash
# Set environment variable with pooler URL
export SUPABASE_DATABASE_URL_1="postgresql://postgres.xxxxx:password@aws-0-us-west-1.pooler.supabase.com:5432/postgres"

# Run with uv (dependencies are automatically installed)
uv run main.py
```

## Manual Execution

Go to the GitHub Actions page, select the `Supabase Database Keep-Alive` workflow, and click the `Run workflow` button to execute manually.

## Change Execution Schedule

Modify the cron expression in the `.github/workflows/keep-alive.yml` file to change the execution schedule:

```yaml
schedule:
  - cron: '0 0 * * 1'  # Every Monday at 00:00 UTC
  # - cron: '0 0 * * *'  # Every day at 00:00 UTC
  # - cron: '0 */12 * * *'  # Every 12 hours
```

## Troubleshooting

### "Network is unreachable" Error
This means you're using the direct connection URL instead of the pooler URL. The direct connection (`db.xxx.supabase.co`) only supports IPv6, which GitHub Actions doesn't support.

**Solution:** Use the Connection Pooler URL (`aws-0-[region].pooler.supabase.com`) as described in the setup instructions above.

### Database Connection Failed
- Verify you're using the **pooler URL**, not the direct connection URL
- Check that the password is correct
- Ensure the Supabase project is active

## License

MIT
