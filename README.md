# Supabase CPR (Database Keep-Alive Service)

An automated service to prevent Supabase databases from sleeping. It periodically accesses the database through GitHub Actions to keep it active.

## How It Works

1. Automatically runs every Monday at 00:00 UTC (or manually triggered)
2. Reads all `SUPABASE_DATABASE_*` environment variables from GitHub Secrets
3. For each database:
   - Creates `cpr_table` if it doesn't exist
   - Inserts a new record if the table exists

## Setup

### 1. Configure GitHub Secrets

Navigate to Repository Settings > Secrets and variables > Actions and add your database connection strings:

```
SUPABASE_DATABASE_URL_1=postgresql://user:password@host:5432/database
SUPABASE_DATABASE_URL_2=postgresql://user:password@host:5432/database
SUPABASE_DATABASE_URL_3=postgresql://user:password@host:5432/database
```

Secret names must start with `SUPABASE_DATABASE_`, followed by any identifier you prefer.

### 2. Get Your Supabase Database URL

From the Supabase Dashboard:
1. Select your project
2. Go to Settings > Database
3. Copy the Connection String > URI
4. Replace `[YOUR-PASSWORD]` with your actual database password

Example:
```
postgresql://postgres.xxxxx:password@aws-0-region.pooler.supabase.com:5432/postgres
```

### 3. Automatic Secret Loading

This project uses `oNaiPs/secrets-to-env-action` to automatically load all secrets starting with `SUPABASE_DATABASE_` as environment variables.

This means you don't need to modify the workflow file when adding new databases. Simply add them to GitHub Secrets and they'll be automatically detected.

## Table Structure

The `cpr_table` that's automatically created:

```sql
CREATE TABLE public.cpr_table (
    id int8 GENERATED BY DEFAULT AS IDENTITY(
        INCREMENT BY 1
        MINVALUE 1
        MAXVALUE 9223372036854775807
        START 1
        CACHE 1
        NO CYCLE
    ) NOT NULL,
    created_at timestamptz DEFAULT now() NOT NULL,
    CONSTRAINT cpr_table_pkey PRIMARY KEY (id)
);
```

## Local Testing

```bash
# Install dependencies
pip install psycopg2-binary

# Set environment variable
export SUPABASE_DATABASE_URL_1="postgresql://..."

# Run
python main.py
```

## Manual Execution

Go to the GitHub Actions page, select the `Supabase Database Keep-Alive` workflow, and click the `Run workflow` button to execute manually.

## Change Execution Schedule

Modify the cron expression in the `.github/workflows/keep-alive.yml` file to change the execution schedule:

```yaml
schedule:
  - cron: '0 0 * * 1'  # Every Monday at 00:00 UTC
  # - cron: '0 0 * * *'  # Every day at 00:00 UTC
  # - cron: '0 */12 * * *'  # Every 12 hours
```

## Troubleshooting

### Database Connection Failed
- Verify the Supabase database URL is correct
- Check that the password is accurate
- Ensure the Supabase project is active

### GitHub Actions Execution Check
- Check the workflow execution logs in the Actions tab
- Review error messages in each step's output

## License

MIT
